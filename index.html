<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sport Coach</title>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            boxShadow: {
              soft: "0 10px 30px rgba(0,0,0,.08)",
            },
          },
        },
      };
    </script>

    <!-- Chart.js (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
      ::-webkit-scrollbar {
        height: 10px;
        width: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.18);
        border-radius: 999px;
      }
      video,
      img {
        display: block;
      }
    </style>
  </head>

  <body class="bg-zinc-50 text-zinc-900">
    <div class="mx-auto max-w-6xl p-4 md:p-8">
      <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-3">
          <div class="h-11 w-11 rounded-2xl bg-white shadow-soft grid place-items-center border border-zinc-200">
            <span class="text-xl">üèãÔ∏è</span>
          </div>
          <div>
            <h1 class="text-xl md:text-2xl font-bold leading-tight">Sport Coach</h1>
            <p class="text-sm text-zinc-500">–û–¥–∏–Ω —Ñ–∞–π–ª. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ GitHub Pages –±–µ–∑ —Å–±–æ—Ä–∫–∏.</p>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <select id="profileSelect" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm shadow-soft"></select>
          <button id="btnAddProfile" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm shadow-soft">+ –ü—Ä–æ—Ñ–∏–ª—å</button>
          <button id="btnRenameProfile" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm shadow-soft">–ü–µ—Ä–µ–∏–º–µ–Ω.</button>
          <button id="btnDeleteProfile" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm shadow-soft">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </header>

      <nav class="mt-5 flex flex-wrap gap-2">
        <button data-tab="dashboard" class="tabBtn rounded-2xl border border-zinc-200 bg-white px-4 py-2 text-sm shadow-soft">–ì–ª–∞–≤–Ω–∞—è</button>
        <button data-tab="menu" class="tabBtn rounded-2xl border border-zinc-200 bg-white px-4 py-2 text-sm shadow-soft">–ú–µ–Ω—é</button>
        <button data-tab="shopping" class="tabBtn rounded-2xl border border-zinc-200 bg-white px-4 py-2 text-sm shadow-soft">–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</button>
        <button data-tab="workouts" class="tabBtn rounded-2xl border border-zinc-200 bg-white px-4 py-2 text-sm shadow-soft">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</button>
        <button data-tab="progress" class="tabBtn rounded-2xl border border-zinc-200 bg-white px-4 py-2 text-sm shadow-soft">–ó–∞–º–µ—Ä—ã / –≤–µ—Å</button>
        <button data-tab="exercises" class="tabBtn rounded-2xl border border-zinc-200 bg-white px-4 py-2 text-sm shadow-soft">–ë–∞–∑–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</button>
      </nav>

      <main class="mt-5">
        <!-- DASHBOARD -->
        <section id="tab-dashboard" class="tabPanel">
          <div class="grid gap-4 md:grid-cols-3">
            <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft">
              <div class="text-sm text-zinc-500">–¶–µ–ª—å</div>
              <div class="mt-1 text-lg font-semibold" id="goalTitle">‚Äî</div>

              <div class="mt-3 grid gap-2">
                <label class="text-sm">–•–æ—á—É –ø–æ—Ö—É–¥–µ—Ç—å –Ω–∞ (–∫–≥)</label>
                <input id="goalLoseKg" type="number" step="0.1" class="rounded-xl border border-zinc-200 px-3 py-2" />

                <label class="text-sm">–¢–µ–º–ø</label>
                <select id="goalPace" class="rounded-xl border border-zinc-200 px-3 py-2">
                  <option value="easy">–õ—ë–≥–∫–∏–π</option>
                  <option value="normal">–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
                  <option value="aggressive">–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π</option>
                </select>

                <button id="btnSaveGoal" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </div>

            <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft md:col-span-2">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="text-sm text-zinc-500">–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ –Ω–µ–¥–µ–ª—è–º</div>
                  <div class="text-lg font-semibold">–ü–ª–∞–Ω —Å–Ω–∏–∂–µ–Ω–∏—è –≤–µ—Å–∞</div>
                </div>
                <button id="btnFillWeights" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –≤–µ—Å–∞</button>
              </div>

              <div class="mt-3 overflow-auto rounded-2xl border border-zinc-200">
                <table class="min-w-full text-sm">
                  <thead class="bg-zinc-50 text-zinc-600">
                    <tr>
                      <th class="text-left px-3 py-2">–ù–µ–¥–µ–ª—è</th>
                      <th class="text-left px-3 py-2">–î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞</th>
                      <th class="text-left px-3 py-2">–¶–µ–ª–µ–≤–æ–π –≤–µ—Å</th>
                      <th class="text-left px-3 py-2">–°–Ω–∏–∂–µ–Ω–∏–µ</th>
                    </tr>
                  </thead>
                  <tbody id="forecastBody"></tbody>
                </table>
              </div>

              <div class="mt-2 text-xs text-zinc-500">–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π (–Ω–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π).</div>
            </div>
          </div>
        </section>

        <!-- MENU -->
        <section id="tab-menu" class="tabPanel hidden">
          <div class="grid gap-4 lg:grid-cols-3">
            <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="text-sm text-zinc-500">–ù–µ–¥–µ–ª—è</div>
                  <div class="text-lg font-semibold" id="menuWeekTitle">‚Äî</div>
                </div>
                <button id="btnResetWeek" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm">–°–±—Ä–æ—Å</button>
              </div>

              <div class="mt-3 grid gap-2">
                <label class="text-sm">–°—Ç–∞—Ä—Ç –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)</label>
                <input id="weekStart" type="date" class="rounded-xl border border-zinc-200 px-3 py-2" />
                <button id="btnSetWeek" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
              </div>

              <div class="mt-4">
                <div class="text-sm font-semibold">–ë–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</div>
                <p class="text-xs text-zinc-500">–ù—É–∂–Ω–∞ –¥–ª—è ¬´–ü–ª–∞–Ω¬ª –∏ ¬´–§–∞–∫—Ç¬ª. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ –ø—Ä–æ–¥—É–∫—Ç—ã.</p>

                <div class="mt-2 grid gap-2">
                  <input id="foodSearch" placeholder="–ø–æ–∏—Å–∫‚Ä¶" class="rounded-xl border border-zinc-200 px-3 py-2 text-sm" />

                  <div class="flex gap-2">
                    <input id="foodName" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ" class="flex-1 rounded-xl border border-zinc-200 px-3 py-2 text-sm" />
                    <input id="foodKcal" placeholder="–∫–∫–∞–ª/100–≥" type="number" class="w-28 rounded-xl border border-zinc-200 px-3 py-2 text-sm" />
                  </div>

                  <div class="flex flex-wrap gap-2">
                    <input id="foodP" placeholder="–±/100" type="number" class="w-24 rounded-xl border border-zinc-200 px-3 py-2 text-sm" />
                    <input id="foodF" placeholder="–∂/100" type="number" class="w-24 rounded-xl border border-zinc-200 px-3 py-2 text-sm" />
                    <input id="foodC" placeholder="—É/100" type="number" class="w-24 rounded-xl border border-zinc-200 px-3 py-2 text-sm" />
                    <button id="btnAddFood" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">–î–æ–±–∞–≤–∏—Ç—å</button>
                  </div>

                  <div id="foodsList" class="mt-2 max-h-64 overflow-auto rounded-2xl border border-zinc-200"></div>
                </div>
              </div>
            </div>

            <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft lg:col-span-2">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <div>
                  <div class="text-sm text-zinc-500">–î–µ–Ω—å</div>
                  <div class="text-lg font-semibold" id="dayTitle">‚Äî</div>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <button id="btnPrevDay" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm">‚Üê</button>
                  <button id="btnNextDay" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm">‚Üí</button>
                  <button id="btnCopyPlanToFact" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">–ü–ª–∞–Ω ‚Üí –§–∞–∫—Ç (–¥–µ–Ω—å)</button>
                </div>
              </div>

              <div class="mt-3 grid gap-3" id="mealsGrid"></div>

              <div class="mt-4 grid gap-3 md:grid-cols-3">
                <div class="rounded-2xl border border-zinc-200 p-3">
                  <div class="text-sm text-zinc-500">–ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å (–§–∞–∫—Ç)</div>
                  <div class="mt-1 text-lg font-semibold" id="dayTotals">‚Äî</div>
                  <div class="text-xs text-zinc-500" id="dayTotalsSub">‚Äî</div>
                </div>
                <div class="rounded-2xl border border-zinc-200 p-3 md:col-span-2">
                  <div class="text-sm font-semibold">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
                  <ul class="mt-2 text-sm text-zinc-600 list-disc pl-5">
                    <li>–£ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –µ—Å—Ç—å <b>–ü–ª–∞–Ω</b> –∏ <b>–§–∞–∫—Ç</b>.</li>
                    <li>–í ¬´–§–∞–∫—Ç¬ª —Ç—ã –¥–æ–±–∞–≤–ª—è–µ—à—å –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –≥—Ä–∞–º–º–∞–º ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç –∫–∫–∞–ª/–ë–ñ–£.</li>
                    <li>¬´–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫¬ª –±–µ—Ä—ë—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ <b>–ü–ª–∞–Ω–∞</b> –Ω–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- SHOPPING -->
        <section id="tab-shopping" class="tabPanel hidden">
          <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div>
                <div class="text-sm text-zinc-500">–ù–µ–¥–µ–ª—è</div>
                <div class="text-lg font-semibold" id="shoppingWeekTitle">‚Äî</div>
              </div>
              <button id="btnExportShopping" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>

            <div class="mt-3 grid gap-2 md:grid-cols-2">
              <div class="rounded-2xl border border-zinc-200 p-3">
                <div class="text-sm text-zinc-500">–ò—Ç–æ–≥–æ (–ø–ª–∞–Ω)</div>
                <div class="mt-1 text-lg font-semibold" id="shoppingSummary">‚Äî</div>
                <div class="text-xs text-zinc-500">–°—É–º–º–∏—Ä—É–µ–º –≥—Ä–∞–º–º—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.</div>
              </div>
              <div class="rounded-2xl border border-zinc-200 p-3">
                <div class="text-sm font-semibold">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
                <div class="mt-2 text-sm text-zinc-600">–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ¬´—É–º–Ω–æ–µ –º–µ–Ω—é-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä¬ª ‚Äî –¥–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ. –ó–¥–µ—Å—å –Ω–∞–¥—ë–∂–Ω—ã–π —Ä–µ–∂–∏–º: —Ç—ã —Å–∞–º(–∞) –ø–ª–∞–Ω–∏—Ä—É–µ—à—å, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç.</div>
              </div>
            </div>

            <div class="mt-3 overflow-auto rounded-2xl border border-zinc-200">
              <table class="min-w-full text-sm">
                <thead class="bg-zinc-50 text-zinc-600">
                  <tr>
                    <th class="text-left px-3 py-2">–ü—Ä–æ–¥—É–∫—Ç</th>
                    <th class="text-left px-3 py-2">–ì—Ä–∞–º–º—ã</th>
                    <th class="text-left px-3 py-2">–ö–∫–∞–ª</th>
                    <th class="text-left px-3 py-2">–ë/–ñ/–£</th>
                  </tr>
                </thead>
                <tbody id="shoppingBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- WORKOUTS -->
        <section id="tab-workouts" class="tabPanel hidden">
          <div class="grid gap-4 lg:grid-cols-3">
            <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft">
              <div class="text-lg font-semibold">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
              <div class="mt-3 grid gap-2">
                <label class="text-sm">–ì–¥–µ —Ç—Ä–µ–Ω–∏—Ä—É–µ—à—å—Å—è?</label>
                <select id="trainingLocation" class="rounded-xl border border-zinc-200 px-3 py-2">
                  <option value="gym">–ó–∞–ª</option>
                  <option value="home">–î–æ–º</option>
                </select>

                <label class="text-sm">–î–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é</label>
                <input id="trainingDays" type="number" min="1" max="7" class="rounded-xl border border-zinc-200 px-3 py-2" />

                <label class="text-sm">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–æ–º–∞</label>
                <div id="equipmentChecks" class="mt-1 grid grid-cols-2 gap-2 text-sm"></div>

                <button id="btnSaveTraining" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </div>

            <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft lg:col-span-2">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <div>
                  <div class="text-sm text-zinc-500">–¢—Ä–µ–∫–µ—Ä</div>
                  <div class="text-lg font-semibold">–ó–∞–ø–∏—Å—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
                </div>
                <button id="btnAddWorkout" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">+ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
              </div>

              <div class="mt-3 grid gap-3" id="workoutLogs"></div>

              <div class="mt-4 rounded-3xl border border-zinc-200 p-4">
                <div class="flex flex-wrap items-center justify-between gap-2">
                  <div>
                    <div class="text-sm text-zinc-500">–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏</div>
                    <div class="text-lg font-semibold">–ö–∞–∫–∏–µ –º—ã—à—Ü—ã –±—ã–ª–∏ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω—ã</div>
                  </div>
                  <button id="btnThisWeek" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</button>
                </div>

                <div class="mt-3">
                  <canvas id="muscleChart" height="120"></canvas>
                </div>

                <div class="mt-2 overflow-auto rounded-2xl border border-zinc-200">
                  <table class="min-w-full text-sm">
                    <thead class="bg-zinc-50 text-zinc-600">
                      <tr>
                        <th class="text-left px-3 py-2">–ú—ã—à—Ü–∞</th>
                        <th class="text-left px-3 py-2">–ì–ª–∞–≤–Ω. –ø–æ–¥—Ö–æ–¥—ã</th>
                        <th class="text-left px-3 py-2">–í—Å–ø–æ–º. –ø–æ–¥—Ö–æ–¥—ã</th>
                        <th class="text-left px-3 py-2">–î–æ–ª—è</th>
                      </tr>
                    </thead>
                    <tbody id="muscleBody"></tbody>
                  </table>
                </div>

                <div class="mt-2 text-xs text-zinc-500">–í–µ—Å: –≥–ª–∞–≤–Ω–∞—è√ó1.0, –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è√ó0.5 (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞).</div>
              </div>
            </div>
          </div>
        </section>

        <!-- PROGRESS -->
        <section id="tab-progress" class="tabPanel hidden">
          <div class="grid gap-4 lg:grid-cols-3">
            <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft">
              <div class="text-lg font-semibold">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ä</div>
              <div class="mt-3 grid gap-2">
                <label class="text-sm">–î–∞—Ç–∞</label>
                <input id="measureDate" type="date" class="rounded-xl border border-zinc-200 px-3 py-2" />

                <label class="text-sm">–í–µ—Å (–∫–≥)</label>
                <input id="measureWeight" type="number" step="0.1" class="rounded-xl border border-zinc-200 px-3 py-2" />

                <label class="text-sm">–¢–∞–ª–∏—è (—Å–º, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input id="measureWaist" type="number" step="0.1" class="rounded-xl border border-zinc-200 px-3 py-2" />

                <button id="btnAddMeasure" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>

            <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft lg:col-span-2">
              <div class="text-sm text-zinc-500">–ì—Ä–∞—Ñ–∏–∫</div>
              <div class="text-lg font-semibold">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
              <div class="mt-3">
                <canvas id="weightChart" height="120"></canvas>
              </div>

              <div class="mt-3 overflow-auto rounded-2xl border border-zinc-200">
                <table class="min-w-full text-sm">
                  <thead class="bg-zinc-50 text-zinc-600">
                    <tr>
                      <th class="text-left px-3 py-2">–î–∞—Ç–∞</th>
                      <th class="text-left px-3 py-2">–í–µ—Å</th>
                      <th class="text-left px-3 py-2">–¢–∞–ª–∏—è</th>
                      <th class="text-left px-3 py-2">‚Äî</th>
                    </tr>
                  </thead>
                  <tbody id="measuresBody"></tbody>
                </table>
              </div>

              <div class="mt-2 text-xs text-zinc-500">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (localStorage).</div>
            </div>
          </div>
        </section>

        <!-- EXERCISES -->
        <section id="tab-exercises" class="tabPanel hidden">
          <div class="grid gap-4 lg:grid-cols-3">
            <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft">
              <div class="text-lg font-semibold">–§–∏–ª—å—Ç—Ä—ã</div>
              <div class="mt-3 grid gap-2">
                <input id="exerciseSearch" placeholder="–ø–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è‚Ä¶" class="rounded-xl border border-zinc-200 px-3 py-2" />
                <label class="text-sm">–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ (–ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é)</label>
                <select id="exerciseAvailability" class="rounded-xl border border-zinc-200 px-3 py-2">
                  <option value="all">–í—Å–µ</option>
                  <option value="only">–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ</option>
                </select>
              </div>

              <div class="mt-4 rounded-2xl border border-zinc-200 p-3">
                <div class="text-sm font-semibold">GIF / –í–∏–¥–µ–æ</div>
                <p class="text-xs text-zinc-500 mt-1">–í —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–∏ –Ω–∞–∂–º–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å GIF/–≤–∏–¥–µ–æ¬ª –∏ –≤—Å—Ç–∞–≤—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ GIF (.gif) –∏–ª–∏ –≤–∏–¥–µ–æ (.mp4/.webm).</p>
              </div>
            </div>

            <div class="rounded-3xl border border-zinc-200 bg-white p-4 shadow-soft lg:col-span-2">
              <div>
                <div class="text-sm text-zinc-500">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</div>
                <div class="text-lg font-semibold">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è + –∑–∞–º–µ–Ω—ã</div>
              </div>
              <div class="mt-3 grid gap-3" id="exerciseList"></div>
            </div>
          </div>
        </section>
      </main>

      <footer class="mt-8 text-xs text-zinc-500 flex flex-wrap items-center justify-between gap-2">
        <div>–ù–∞–¥—ë–∂–Ω–∞—è ¬´single-file¬ª –≤–µ—Ä—Å–∏—è (–±–µ–∑ npm). –î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ).</div>
        <div id="jsStatus" class="rounded-xl border border-zinc-200 bg-white px-2 py-1">JS: loading‚Ä¶</div>
      </footer>
    </div>

    <script>
      // =============================================================
      //  Sport Coach Single-file v2 (stable)
      // =============================================================

      function escapeHtml(s) {
        return String(s ?? "").replace(/[&<>]/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[m]));
      }
      function escapeAttr(s) {
        return String(s ?? "").replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
      }
      function uid() {
        return Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function isoToday() {
        const d = new Date();
        d.setHours(0, 0, 0, 0);
        return d.toISOString().slice(0, 10);
      }
      function addDaysISO(iso, days) {
        const d = new Date(iso + "T00:00:00");
        d.setDate(d.getDate() + days);
        return d.toISOString().slice(0, 10);
      }
      function weekStartMondayISO(date = new Date()) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        const day = d.getDay();
        const diff = (day === 0 ? -6 : 1) - day;
        d.setDate(d.getDate() + diff);
        return d.toISOString().slice(0, 10);
      }
      function round(n, d = 1) {
        const p = Math.pow(10, d);
        return Math.round((Number(n) || 0) * p) / p;
      }
      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }

      const STORAGE_KEY = "sport_coach_singlefile_v2";

      // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ: –µ—Å–ª–∏ localStorage –∑–∞–ø—Ä–µ—â—ë–Ω (—á–∞—Å—Ç–æ –Ω–∞ iPhone/Private), –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.
      const storage = (() => {
        try {
          const t = "__sc_test__";
          window.localStorage.setItem(t, "1");
          window.localStorage.removeItem(t);
          return window.localStorage;
        } catch (e) {
          const mem = {};
          return {
            getItem: (k) => (k in mem ? mem[k] : null),
            setItem: (k, v) => {
              mem[k] = String(v);
            },
            removeItem: (k) => {
              delete mem[k];
            },
          };
        }
      })();

      // –ü–æ–∫–∞–∑ –æ—à–∏–±–æ–∫ –ø—Ä—è–º–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´–∫–Ω–æ–ø–∫–∏ –º—ë—Ä—Ç–≤—ã–µ¬ª –∏–∑‚Äë–∑–∞ —Å–∫—Ä—ã—Ç–æ–≥–æ –∫—Ä–∞—à–∞)
      function showErrorBanner(msg) {
        try {
          let el = document.getElementById("__errBanner");
          if (!el) {
            el = document.createElement("div");
            el.id = "__errBanner";
            el.className = "fixed left-3 right-3 bottom-3 z-[9999] rounded-2xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800 shadow-soft";
            document.body.appendChild(el);
          }
          el.innerHTML = `<div class="font-semibold">–û—à–∏–±–∫–∞ –≤ —Å–∫—Ä–∏–ø—Ç–µ</div><div class="mt-1 whitespace-pre-wrap">${escapeHtml(msg)}</div>`;
        } catch {}
      }

      window.addEventListener("error", (e) => {
        showErrorBanner(e?.message || String(e));
      });
      window.addEventListener("unhandledrejection", (e) => {
        showErrorBanner(e?.reason?.message || String(e?.reason || e));
      });

      // –§–ª–∞–∂–æ–∫, —á—Ç–æ JS –∑–∞–ø—É—Å—Ç–∏–ª—Å—è (–¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)
      document.documentElement.dataset.js = "ok";
      // –í–∏–¥–∏–º—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, —á—Ç–æ JS —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
      (function(){
        const el = document.getElementById("jsStatus");
        if (el) el.textContent = "JS: OK";
      })();

      // Debug-—Ä–µ–∂–∏–º: –¥–æ–±–∞–≤—å –≤ –∫–æ–Ω–µ—Ü —Å—Å—ã–ª–∫–∏ #debug, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∫–ª–∏–∫–∏
      if (location.hash === "#debug") {
        const toast = document.createElement("div");
        toast.className = "fixed top-3 left-3 z-[9999] rounded-2xl border border-zinc-200 bg-white px-3 py-2 text-sm shadow-soft hidden";
        document.body.appendChild(toast);
        document.addEventListener(
          "click",
          (e) => {
            const t = e.target;
            const label = (t?.tagName || "?") + (t?.id ? "#" + t.id : "") + (t?.dataset?.tab ? "[tab=" + t.dataset.tab + "]" : "");
            toast.textContent = "click: " + label;
            toast.classList.remove("hidden");
            clearTimeout(toast.__t);
            toast.__t = setTimeout(() => toast.classList.add("hidden"), 900);
          },
          true
        );
      }


      const EQUIPMENT = [
        { id: "none", label: "–ë–µ–∑" },
        { id: "dumbbells", label: "–ì–∞–Ω—Ç–µ–ª–∏" },
        { id: "kettlebell", label: "–ì–∏—Ä—è" },
        { id: "bands", label: "–†–µ–∑–∏–Ω–∫–∏" },
        { id: "pullup_bar", label: "–¢—É—Ä–Ω–∏–∫" },
        { id: "bench", label: "–°–∫–∞–º—å—è" },
        { id: "barbell", label: "–®—Ç–∞–Ω–≥–∞" },
        { id: "cable", label: "–ë–ª–æ–∫" },
        { id: "machines", label: "–¢—Ä–µ–Ω–∞–∂—ë—Ä—ã" },
      ];

      const MEAL_KEYS = [
        { key: "breakfast", label: "–ó–∞–≤—Ç—Ä–∞–∫" },
        { key: "lunch", label: "–û–±–µ–¥" },
        { key: "snack", label: "–ü–µ—Ä–µ–∫—É—Å" },
        { key: "dinner", label: "–£–∂–∏–Ω" },
      ];

      const EXERCISES = [
        { id: "pushup", name: "–û—Ç–∂–∏–º–∞–Ω–∏—è", muscle: "–ì—Ä—É–¥—å", secondary: ["–ü–ª–µ—á–∏", "–†—É–∫–∏", "–ö–æ—Ä"], equip: ["none"], alt: "–ù–µ—Ç —Å–∫–∞–º—å–∏ ‚Üí –æ—Ç–∂–∏–º–∞–Ω–∏—è" },
        { id: "db_bench", name: "–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞", muscle: "–ì—Ä—É–¥—å", secondary: ["–ü–ª–µ—á–∏", "–†—É–∫–∏"], equip: ["dumbbells", "bench"], alt: "–ù–µ—Ç —Å–∫–∞–º—å–∏ ‚Üí –æ—Ç–∂–∏–º–∞–Ω–∏—è" },
        { id: "bb_bench", name: "–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª—ë–∂–∞", muscle: "–ì—Ä—É–¥—å", secondary: ["–ü–ª–µ—á–∏", "–†—É–∫–∏"], equip: ["barbell", "bench"], alt: "–ù–µ—Ç —à—Ç–∞–Ω–≥–∏ ‚Üí –∂–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π" },
        { id: "pullup", name: "–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", muscle: "–°–ø–∏–Ω–∞", secondary: ["–†—É–∫–∏", "–ö–æ—Ä"], equip: ["pullup_bar"], alt: "–ù–µ—Ç —Ç—É—Ä–Ω–∏–∫–∞ ‚Üí —Ç—è–≥–∞ —Ä–µ–∑–∏–Ω–∫–∏ —Å–≤–µ—Ä—Ö—É" },
        { id: "row_db", name: "–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", muscle: "–°–ø–∏–Ω–∞", secondary: ["–†—É–∫–∏", "–ö–æ—Ä"], equip: ["dumbbells"], alt: "–ù–µ—Ç –≥–∞–Ω—Ç–µ–ª–µ–π ‚Üí —Ç—è–≥–∞ —Ä–µ–∑–∏–Ω–∫–∏" },
        { id: "lat_band", name: "–¢—è–≥–∞ —Ä–µ–∑–∏–Ω–∫–∏ —Å–≤–µ—Ä—Ö—É", muscle: "–°–ø–∏–Ω–∞", secondary: ["–†—É–∫–∏"], equip: ["bands"], alt: "–ù–µ—Ç —Ä–µ–∑–∏–Ω–∫–∏ ‚Üí —Ç—è–≥–∞ –ø–æ–ª–æ—Ç–µ–Ω—Ü–∞/–ø–æ–¥ —Å—Ç–æ–ª–æ–º" },
        { id: "squat_bw", name: "–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–≤–µ—Å —Ç–µ–ª–∞)", muscle: "–ù–æ–≥–∏", secondary: ["–ö–æ—Ä"], equip: ["none"], alt: "‚Äî" },
        { id: "goblet", name: "–ì–æ–±–ª–µ—Ç-–ø—Ä–∏—Å–µ–¥", muscle: "–ù–æ–≥–∏", secondary: ["–ö–æ—Ä"], equip: ["dumbbells", "kettlebell"], alt: "–ù–µ—Ç –≤–µ—Å–∞ ‚Üí –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è" },
        { id: "rdl_db", name: "–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞ (–≥–∞–Ω—Ç–µ–ª–∏)", muscle: "–ù–æ–≥–∏", secondary: ["–°–ø–∏–Ω–∞", "–ö–æ—Ä"], equip: ["dumbbells"], alt: "–ù–µ—Ç –≥–∞–Ω—Ç–µ–ª–µ–π ‚Üí —è–≥–æ–¥–∏—á–Ω—ã–π –º–æ—Å—Ç" },
        { id: "ohp_db", name: "–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π", muscle: "–ü–ª–µ—á–∏", secondary: ["–†—É–∫–∏", "–ö–æ—Ä"], equip: ["dumbbells"], alt: "–ù–µ—Ç –≥–∞–Ω—Ç–µ–ª–µ–π ‚Üí –æ—Ç–∂–∏–º–∞–Ω–∏—è —É–≥–æ–ª–∫–æ–º" },
        { id: "pike", name: "–û—Ç–∂–∏–º–∞–Ω–∏—è —É–≥–æ–ª–∫–æ–º", muscle: "–ü–ª–µ—á–∏", secondary: ["–†—É–∫–∏", "–ö–æ—Ä"], equip: ["none"], alt: "‚Äî" },
        { id: "curl_db", name: "–ë–∏—Ü–µ–ø—Å (–≥–∞–Ω—Ç–µ–ª–∏)", muscle: "–†—É–∫–∏", secondary: [], equip: ["dumbbells"], alt: "–ù–µ—Ç –≥–∞–Ω—Ç–µ–ª–µ–π ‚Üí —Ä–µ–∑–∏–Ω–∫–∞" },
        { id: "curl_band", name: "–ë–∏—Ü–µ–ø—Å (—Ä–µ–∑–∏–Ω–∫–∞)", muscle: "–†—É–∫–∏", secondary: [], equip: ["bands"], alt: "‚Äî" },
        { id: "plank", name: "–ü–ª–∞–Ω–∫–∞", muscle: "–ö–æ—Ä", secondary: [], equip: ["none"], alt: "‚Äî" },
      ];

      function placeholderSVG(title, sub) {
        const t = escapeHtml(String(title || "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ").slice(0, 26));
        const s = escapeHtml(String(sub || "").slice(0, 40));
        const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="640" height="400" viewBox="0 0 640 400">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#ffffff"/>
      <stop offset="1" stop-color="#f4f4f5"/>
    </linearGradient>
  </defs>
  <rect x="0" y="0" width="640" height="400" rx="28" fill="url(#g)" stroke="#e4e4e7"/>
  <g fill="none" stroke="#111827" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" opacity="0.9">
    <circle cx="170" cy="140" r="28"/>
    <path d="M170 170 L170 250" />
    <path d="M170 200 L120 230" />
    <path d="M170 200 L220 230" />
    <path d="M170 250 L130 320" />
    <path d="M170 250 L220 320" />
    <path d="M260 310 L520 310" opacity="0.35" />
  </g>
  <text x="320" y="105" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-size="28" fill="#111827" font-weight="700">${t}</text>
  <text x="320" y="145" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-size="16" fill="#52525b">${s}</text>
  <text x="320" y="370" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-size="14" fill="#71717a">(–ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ GIF/–≤–∏–¥–µ–æ)</text>
</svg>`;
        return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
      }

      function isVideoSrc(src) {
        const s = String(src || "").toLowerCase();
        return (
          s.startsWith("data:video/") ||
          s.endsWith(".mp4") ||
          s.endsWith(".webm") ||
          s.endsWith(".mov") ||
          s.includes(".mp4?") ||
          s.includes(".webm?") ||
          s.includes(".mov?")
        );
      }

      function renderMedia(src, alt, mode) {
        const safeSrc = escapeAttr(src);
        const safeAlt = escapeAttr(alt);
        const base = mode === "thumb" ? "h-16 w-24" : "w-full max-h-[420px]";
        const fit = mode === "thumb" ? "object-cover" : "object-contain";
        if (isVideoSrc(src)) {
          const attrs = mode === "thumb" ? "muted loop playsinline autoplay" : "muted loop playsinline controls";
          return `<video class="${base} ${fit} rounded-xl" src="${safeSrc}" ${attrs}></video>`;
        }
        return `<img class="${base} ${fit} rounded-xl" src="${safeSrc}" alt="${safeAlt}" loading="lazy" />`;
      }

      function defaultFoods() {
        return [
          { id: "chicken", name: "–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞", kcal100: 165, p100: 31, f100: 3.6, c100: 0 },
          { id: "rice", name: "–†–∏—Å –≤–∞—Ä—ë–Ω—ã–π", kcal100: 130, p100: 2.7, f100: 0.3, c100: 28 },
          { id: "oats", name: "–û–≤—Å—è–Ω–∫–∞", kcal100: 370, p100: 13, f100: 7, c100: 62 },
          { id: "eggs", name: "–Ø–π—Ü–∞", kcal100: 155, p100: 13, f100: 11, c100: 1.1 },
          { id: "cottage", name: "–¢–≤–æ—Ä–æ–≥ 5%", kcal100: 121, p100: 17, f100: 5, c100: 3 },
          { id: "banana", name: "–ë–∞–Ω–∞–Ω", kcal100: 89, p100: 1.1, f100: 0.3, c100: 23 },
          { id: "olive", name: "–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ", kcal100: 884, p100: 0, f100: 100, c100: 0 },
          { id: "veg", name: "–û–≤–æ—â–∏ (—Å–º–µ—à.)", kcal100: 35, p100: 2, f100: 0.3, c100: 7 },
        ];
      }

      function emptyMeal() {
        return { items: [] };
      }
      function emptyDayMeals() {
        const out = {};
        for (const m of MEAL_KEYS) out[m.key] = { plan: emptyMeal(), fact: emptyMeal(), eaten: true };
        return out;
      }

      function makeDefaultProfile(name = "–ü—Ä–æ—Ñ–∏–ª—å") {
        const weekStart = weekStartMondayISO();
        return {
          name,
          profile: { sex: "male", age: 28, heightCm: 178, weightKg: 82 },
          goal: { loseKg: 6, pace: "normal" },
          training: {
            location: "gym",
            daysPerWeek: 4,
            equipment: Object.fromEntries(EQUIPMENT.map((e) => [e.id, e.id === "none" || e.id === "dumbbells" || e.id === "bands"]))
          },
          foods: defaultFoods(),
          nutrition: { weekStartISO: weekStart, days: {} },
          measures: [{ dateISO: isoToday(), weightKg: 82 }],
          workouts: [],
          library: { exerciseMedia: {} },
        };
      }

      function loadState() {
        try {
          const raw = storage.getItem(STORAGE_KEY);
          if (!raw) throw new Error("no state");
          const s = JSON.parse(raw);
          if (!s || !s.currentProfileId || !s.profiles) throw new Error("bad shape");
          return s;
        } catch {
          const id = uid();
          const p = makeDefaultProfile("–ü—Ä–æ—Ñ–∏–ª—å 1");
          const s = { currentProfileId: id, profiles: { [id]: p } };
          storage.setItem(STORAGE_KEY, JSON.stringify(s));
          return s;
        }
      }

      let state = loadState();
      function saveState() {
        storage.setItem(STORAGE_KEY, JSON.stringify(state));
      }
      function currentProfile() {
        return state.profiles[state.currentProfileId];
      }

      function ensureDay(p, dateISO) {
        const days = p.nutrition.days;
        if (!days[dateISO]) days[dateISO] = emptyDayMeals();
        for (const m of MEAL_KEYS) {
          if (!days[dateISO][m.key]) days[dateISO][m.key] = { plan: emptyMeal(), fact: emptyMeal(), eaten: true };
          if (!days[dateISO][m.key].plan) days[dateISO][m.key].plan = emptyMeal();
          if (!days[dateISO][m.key].fact) days[dateISO][m.key].fact = emptyMeal();
          if (typeof days[dateISO][m.key].eaten !== "boolean") days[dateISO][m.key].eaten = true;
        }
      }

      function findFood(p, id) {
        return (p.foods || []).find((f) => f.id === id) || null;
      }

      function calcMeal(p, meal) {
        let kcal = 0, pr = 0, fa = 0, ca = 0;
        for (const it of meal.items || []) {
          const f = findFood(p, it.foodId);
          if (!f) continue;
          const g = Number(it.grams) || 0;
          const mul = g / 100;
          kcal += (Number(f.kcal100) || 0) * mul;
          pr += (Number(f.p100) || 0) * mul;
          fa += (Number(f.f100) || 0) * mul;
          ca += (Number(f.c100) || 0) * mul;
        }
        return { kcal: round(kcal, 0), p: round(pr, 1), f: round(fa, 1), c: round(ca, 1) };
      }

      function recomputeDayTotals(p, dateISO) {
        ensureDay(p, dateISO);
        let kcal = 0, pr = 0, fa = 0, ca = 0;
        for (const m of MEAL_KEYS) {
          const slot = p.nutrition.days[dateISO][m.key];
          if (!slot.eaten) continue;
          const t = calcMeal(p, slot.fact);
          kcal += t.kcal; pr += t.p; fa += t.f; ca += t.c;
        }
        return { kcal: round(kcal, 0), p: round(pr, 1), f: round(fa, 1), c: round(ca, 1) };
      }

      // DOM refs
      const tabBtns = Array.from(document.querySelectorAll(".tabBtn"));
      const panels = {
        dashboard: document.getElementById("tab-dashboard"),
        menu: document.getElementById("tab-menu"),
        shopping: document.getElementById("tab-shopping"),
        workouts: document.getElementById("tab-workouts"),
        progress: document.getElementById("tab-progress"),
        exercises: document.getElementById("tab-exercises"),
      };
      let activeTab = "dashboard";
      let selectedDayOffset = 0;

      function setTab(tab) {
        activeTab = tab;
        for (const [k, el] of Object.entries(panels)) el.classList.toggle("hidden", k !== tab);
        for (const b of tabBtns) {
          const on = b.dataset.tab === tab;
          b.classList.toggle("bg-zinc-900", on);
          b.classList.toggle("text-white", on);
          b.classList.toggle("bg-white", !on);
        }
        render();
      }
      tabBtns.forEach((b) => b.addEventListener("click", () => setTab(b.dataset.tab)));

      // Profile UI
      const profileSelect = document.getElementById("profileSelect");
      const btnAddProfile = document.getElementById("btnAddProfile");
      const btnRenameProfile = document.getElementById("btnRenameProfile");
      const btnDeleteProfile = document.getElementById("btnDeleteProfile");

      function rebuildProfileSelect() {
        const entries = Object.entries(state.profiles);
        profileSelect.innerHTML = entries.map(([id, p]) => `<option value="${escapeAttr(id)}">${escapeHtml(p.name)}</option>`).join("");
        profileSelect.value = state.currentProfileId;
      }

      profileSelect.addEventListener("change", () => {
        state.currentProfileId = profileSelect.value;
        saveState();
        render();
      });

      btnAddProfile.addEventListener("click", () => {
        const name = prompt("–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è", "–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å");
        if (!name) return;
        const id = uid();
        state.profiles[id] = makeDefaultProfile(name.trim());
        state.currentProfileId = id;
        saveState();
        rebuildProfileSelect();
        render();
      });

      btnRenameProfile.addEventListener("click", () => {
        const p = currentProfile();
        const name = prompt("–ù–æ–≤–æ–µ –∏–º—è –ø—Ä–æ—Ñ–∏–ª—è", p.name);
        if (!name) return;
        p.name = name.trim();
        saveState();
        rebuildProfileSelect();
        render();
      });

      btnDeleteProfile.addEventListener("click", () => {
        const ids = Object.keys(state.profiles);
        if (ids.length <= 1) return alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—å.");
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å?")) return;
        delete state.profiles[state.currentProfileId];
        state.currentProfileId = Object.keys(state.profiles)[0];
        saveState();
        rebuildProfileSelect();
        render();
      });

      // Dashboard
      const goalTitle = document.getElementById("goalTitle");
      const goalLoseKg = document.getElementById("goalLoseKg");
      const goalPace = document.getElementById("goalPace");
      const btnSaveGoal = document.getElementById("btnSaveGoal");
      const btnFillWeights = document.getElementById("btnFillWeights");
      const forecastBody = document.getElementById("forecastBody");

      function paceKgPerWeek(pace) {
        if (pace === "easy") return 0.25;
        if (pace === "aggressive") return 0.75;
        return 0.5;
      }

      btnSaveGoal.addEventListener("click", () => {
        const p = currentProfile();
        p.goal.loseKg = Number(goalLoseKg.value) || 0;
        p.goal.pace = goalPace.value;
        saveState();
        render();
      });

      btnFillWeights.addEventListener("click", () => {
        const p = currentProfile();
        const last = (p.measures || []).slice().sort((a, b) => (a.dateISO > b.dateISO ? 1 : -1)).slice(-1)[0];
        if (!last) return alert("–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∑–∞–º–µ—Ä –≤–µ—Å–∞.");
        p.profile.weightKg = last.weightKg;
        saveState();
        render();
      });

      function renderForecast() {
        const p = currentProfile();
        const lose = clamp(Number(p.goal.loseKg) || 0, 0, 100);
        const pace = paceKgPerWeek(p.goal.pace);
        const last = (p.measures || []).slice().sort((a, b) => (a.dateISO > b.dateISO ? 1 : -1)).slice(-1)[0];
        const startW = Number(last?.weightKg ?? p.profile.weightKg ?? 80);
        const weeks = Math.max(1, Math.ceil(lose / (pace || 1)));
        const startISO = weekStartMondayISO();

        goalTitle.textContent = lose > 0 ? `–ú–∏–Ω—É—Å ${lose} –∫–≥ (${p.goal.pace})` : "–ü–æ—Å—Ç–∞–≤—å —Ü–µ–ª—å";
        goalLoseKg.value = String(p.goal.loseKg ?? 0);
        goalPace.value = p.goal.pace;

        forecastBody.innerHTML = Array.from({ length: weeks }, (_, i) => {
          const drop = Math.min(lose, pace * (i + 1));
          const w = round(startW - drop, 1);
          const iso = addDaysISO(startISO, i * 7);
          return `
            <tr class="border-t border-zinc-200">
              <td class="px-3 py-2">${i + 1}</td>
              <td class="px-3 py-2">${escapeHtml(iso)}</td>
              <td class="px-3 py-2 font-medium">${w} –∫–≥</td>
              <td class="px-3 py-2">-${round(drop, 2)} –∫–≥</td>
            </tr>
          `;
        }).join("");
      }

      // Menu
      const weekStartInput = document.getElementById("weekStart");
      const btnSetWeek = document.getElementById("btnSetWeek");
      const btnResetWeek = document.getElementById("btnResetWeek");
      const menuWeekTitle = document.getElementById("menuWeekTitle");
      const dayTitle = document.getElementById("dayTitle");
      const btnPrevDay = document.getElementById("btnPrevDay");
      const btnNextDay = document.getElementById("btnNextDay");
      const mealsGrid = document.getElementById("mealsGrid");
      const btnCopyPlanToFact = document.getElementById("btnCopyPlanToFact");
      const dayTotals = document.getElementById("dayTotals");
      const dayTotalsSub = document.getElementById("dayTotalsSub");

      function getSelectedDateISO(p) {
        const start = p.nutrition.weekStartISO || weekStartMondayISO();
        return addDaysISO(start, selectedDayOffset);
      }

      btnSetWeek.addEventListener("click", () => {
        const p = currentProfile();
        const v = weekStartInput.value;
        if (!v) return;
        p.nutrition.weekStartISO = v;
        selectedDayOffset = 0;
        saveState();
        render();
      });

      btnResetWeek.addEventListener("click", () => {
        const p = currentProfile();
        if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω –∏ —Ñ–∞–∫—Ç –Ω–∞ –Ω–µ–¥–µ–ª—é?")) return;
        const start = p.nutrition.weekStartISO || weekStartMondayISO();
        for (let i = 0; i < 7; i++) delete p.nutrition.days[addDaysISO(start, i)];
        saveState();
        render();
      });

      btnPrevDay.addEventListener("click", () => {
        selectedDayOffset = (selectedDayOffset + 6) % 7;
        render();
      });

      btnNextDay.addEventListener("click", () => {
        selectedDayOffset = (selectedDayOffset + 1) % 7;
        render();
      });

      btnCopyPlanToFact.addEventListener("click", () => {
        const p = currentProfile();
        const dateISO = getSelectedDateISO(p);
        ensureDay(p, dateISO);
        for (const m of MEAL_KEYS) {
          const slot = p.nutrition.days[dateISO][m.key];
          slot.fact.items = JSON.parse(JSON.stringify(slot.plan.items || []));
          slot.eaten = true;
        }
        saveState();
        render();
      });

      function renderMealEditor(p, dateISO, mealKey) {
        const slot = p.nutrition.days[dateISO][mealKey];
        const plan = calcMeal(p, slot.plan);
        const fact = calcMeal(p, slot.fact);

        const foodsOptions = (p.foods || [])
          .slice()
          .sort((a, b) => a.name.localeCompare(b.name, "ru"))
          .map((f) => `<option value="${escapeAttr(f.id)}">${escapeHtml(f.name)}</option>`)
          .join("");

        const renderItems = (items) => {
          if (!items || !items.length) return `<div class="text-xs text-zinc-500">–ü—É—Å—Ç–æ</div>`;
          return items
            .map((it, idx) => {
              const f = findFood(p, it.foodId);
              return `
                <div class="flex items-center justify-between gap-2 rounded-xl border border-zinc-200 p-2">
                  <div class="text-sm">
                    <div class="font-medium">${escapeHtml(f?.name || "(–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)")}</div>
                    <div class="text-xs text-zinc-500">${round(it.grams, 0)} –≥</div>
                  </div>
                  <button data-action="delItem" data-idx="${idx}" class="rounded-xl border border-zinc-200 bg-white px-2 py-1 text-xs">‚úï</button>
                </div>
              `;
            })
            .join("");
        };

        const mk = MEAL_KEYS.find((m) => m.key === mealKey)?.label || mealKey;

        return `
          <div class="rounded-3xl border border-zinc-200 p-3" data-meal="${escapeAttr(mealKey)}">
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="text-sm font-semibold">${escapeHtml(mk)}</div>
                <div class="text-xs text-zinc-500">–ü–ª–∞–Ω: ${plan.kcal} –∫–∫–∞–ª ¬∑ ${plan.p}/${plan.f}/${plan.c} | –§–∞–∫—Ç: ${fact.kcal} –∫–∫–∞–ª ¬∑ ${fact.p}/${fact.f}/${fact.c}</div>
              </div>
              <label class="text-xs flex items-center gap-2">
                <input type="checkbox" data-action="toggleEaten" ${slot.eaten ? "checked" : ""} />
                –°—ä–µ–ª
              </label>
            </div>

            <div class="mt-3 grid gap-3 md:grid-cols-2">
              <div data-mode="plan">
                <div class="text-xs font-semibold text-zinc-700">–ü–ª–∞–Ω</div>
                <div class="mt-2 grid gap-2">
                  ${renderItems(slot.plan.items || [])}
                  <div class="mt-2 flex gap-2">
                    <select data-field="food" class="flex-1 rounded-xl border border-zinc-200 px-2 py-2 text-sm">${foodsOptions}</select>
                    <input data-field="grams" type="number" placeholder="–≥" class="w-20 rounded-xl border border-zinc-200 px-2 py-2 text-sm" />
                    <button data-action="addPlan" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">+</button>
                  </div>
                </div>
              </div>

              <div data-mode="fact">
                <div class="text-xs font-semibold text-zinc-700">–§–∞–∫—Ç</div>
                <div class="mt-2 grid gap-2">
                  ${renderItems(slot.fact.items || [])}
                  <div class="mt-2 flex gap-2">
                    <select data-field="food" class="flex-1 rounded-xl border border-zinc-200 px-2 py-2 text-sm">${foodsOptions}</select>
                    <input data-field="grams" type="number" placeholder="–≥" class="w-20 rounded-xl border border-zinc-200 px-2 py-2 text-sm" />
                    <button data-action="addFact" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">+</button>
                  </div>
                  <div class="mt-2 flex gap-2">
                    <button data-action="clearFact" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∞–∫—Ç</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      mealsGrid.addEventListener("click", (ev) => {
        const btn = ev.target.closest("button");
        if (!btn) return;
        const mealBox = ev.target.closest("[data-meal]");
        if (!mealBox) return;

        const p = currentProfile();
        const dateISO = getSelectedDateISO(p);
        ensureDay(p, dateISO);
        const mealKey = mealBox.dataset.meal;
        const slot = p.nutrition.days[dateISO][mealKey];

        const action = btn.dataset.action;
        const modeBox = btn.closest("[data-mode]");
        const mode = modeBox?.dataset.mode;

        const getFields = (container) => {
          const foodSel = container.querySelector("select[data-field='food']");
          const gramsInp = container.querySelector("input[data-field='grams']");
          return { foodId: foodSel?.value, grams: Number(gramsInp?.value) || 0, gramsInp };
        };

        if (action === "addPlan") {
          const { foodId, grams, gramsInp } = getFields(modeBox);
          if (!foodId || grams <= 0) return;
          slot.plan.items.push({ foodId, grams });
          if (gramsInp) gramsInp.value = "";
          saveState();
          render();
          return;
        }

        if (action === "addFact") {
          const { foodId, grams, gramsInp } = getFields(modeBox);
          if (!foodId || grams <= 0) return;
          slot.fact.items.push({ foodId, grams });
          if (gramsInp) gramsInp.value = "";
          saveState();
          render();
          return;
        }

        if (action === "delItem") {
          const idx = Number(btn.dataset.idx);
          if (mode === "plan") slot.plan.items.splice(idx, 1);
          if (mode === "fact") slot.fact.items.splice(idx, 1);
          saveState();
          render();
          return;
        }

        if (action === "clearFact") {
          slot.fact.items = [];
          saveState();
          render();
          return;
        }
      });

      mealsGrid.addEventListener("change", (ev) => {
        const cb = ev.target.closest("input[type='checkbox'][data-action='toggleEaten']");
        if (!cb) return;
        const mealBox = ev.target.closest("[data-meal]");
        if (!mealBox) return;
        const p = currentProfile();
        const dateISO = getSelectedDateISO(p);
        ensureDay(p, dateISO);
        p.nutrition.days[dateISO][mealBox.dataset.meal].eaten = cb.checked;
        saveState();
        render();
      });

      // Food DB UI
      const foodSearch = document.getElementById("foodSearch");
      const foodName = document.getElementById("foodName");
      const foodKcal = document.getElementById("foodKcal");
      const foodP = document.getElementById("foodP");
      const foodF = document.getElementById("foodF");
      const foodC = document.getElementById("foodC");
      const btnAddFood = document.getElementById("btnAddFood");
      const foodsList = document.getElementById("foodsList");

      btnAddFood.addEventListener("click", () => {
        const p = currentProfile();
        const name = foodName.value.trim();
        if (!name) return;
        const f = {
          id: uid(),
          name,
          kcal100: Number(foodKcal.value) || 0,
          p100: Number(foodP.value) || 0,
          f100: Number(foodF.value) || 0,
          c100: Number(foodC.value) || 0,
        };
        p.foods.push(f);
        foodName.value = "";
        foodKcal.value = "";
        foodP.value = "";
        foodF.value = "";
        foodC.value = "";
        saveState();
        renderFoods();
        render();
      });

      function renderFoods() {
        const p = currentProfile();
        const q = foodSearch.value.trim().toLowerCase();
        const list = (p.foods || [])
          .filter((f) => !q || f.name.toLowerCase().includes(q))
          .slice()
          .sort((a, b) => a.name.localeCompare(b.name, "ru"));

        foodsList.innerHTML = list
          .map((f) => {
            return `
              <div class="flex items-center justify-between gap-2 border-b border-zinc-200 p-2">
                <div class="min-w-0">
                  <div class="text-sm font-medium truncate">${escapeHtml(f.name)}</div>
                  <div class="text-xs text-zinc-500">${round(f.kcal100, 0)} –∫–∫–∞–ª ¬∑ ${round(f.p100, 1)}/${round(f.f100, 1)}/${round(f.c100, 1)} –Ω–∞ 100–≥</div>
                </div>
                <button data-food-del="${escapeAttr(f.id)}" class="rounded-xl border border-zinc-200 bg-white px-2 py-1 text-xs">‚úï</button>
              </div>
            `;
          })
          .join("");

        foodsList.querySelectorAll("button[data-food-del]").forEach((b) => {
          b.addEventListener("click", () => {
            const id = b.dataset.foodDel;
            if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç?")) return;
            p.foods = p.foods.filter((x) => x.id !== id);
            saveState();
            renderFoods();
            render();
          });
        });
      }
      foodSearch.addEventListener("input", renderFoods);

      // Shopping
      const shoppingWeekTitle = document.getElementById("shoppingWeekTitle");
      const shoppingSummary = document.getElementById("shoppingSummary");
      const shoppingBody = document.getElementById("shoppingBody");
      const btnExportShopping = document.getElementById("btnExportShopping");

      function computeShopping(p) {
        const start = p.nutrition.weekStartISO || weekStartMondayISO();
        const grams = new Map();
        for (let i = 0; i < 7; i++) {
          const iso = addDaysISO(start, i);
          ensureDay(p, iso);
          for (const m of MEAL_KEYS) {
            for (const it of p.nutrition.days[iso][m.key].plan.items || []) {
              grams.set(it.foodId, (grams.get(it.foodId) || 0) + (Number(it.grams) || 0));
            }
          }
        }

        const rows = Array.from(grams.entries())
          .map(([foodId, g]) => {
            const f = findFood(p, foodId);
            const mul = g / 100;
            const kcal = (Number(f?.kcal100) || 0) * mul;
            const pr = (Number(f?.p100) || 0) * mul;
            const fa = (Number(f?.f100) || 0) * mul;
            const ca = (Number(f?.c100) || 0) * mul;
            return { name: f?.name || "(–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)", grams: round(g, 0), kcal: round(kcal, 0), p: round(pr, 1), f: round(fa, 1), c: round(ca, 1) };
          })
          .sort((a, b) => b.grams - a.grams);

        const total = rows.reduce((acc, r) => {
          acc.kcal += r.kcal;
          acc.p += r.p;
          acc.f += r.f;
          acc.c += r.c;
          return acc;
        }, { kcal: 0, p: 0, f: 0, c: 0 });

        return { start, rows, total };
      }

      btnExportShopping.addEventListener("click", async () => {
        const p = currentProfile();
        const { rows, start } = computeShopping(p);
        const lines = [`–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ (–Ω–µ–¥–µ–ª—è ${start})`];
        for (const r of rows) lines.push(`- ${r.name}: ${r.grams} –≥`);
        const text = lines.join("
");
        try {
          await navigator.clipboard.writeText(text);
          alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ");
        } catch {
          prompt("–°–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é:", text);
        }
      });

      // Workouts
      const trainingLocation = document.getElementById("trainingLocation");
      const trainingDays = document.getElementById("trainingDays");
      const equipmentChecks = document.getElementById("equipmentChecks");
      const btnSaveTraining = document.getElementById("btnSaveTraining");
      const btnAddWorkout = document.getElementById("btnAddWorkout");
      const workoutLogs = document.getElementById("workoutLogs");
      const btnThisWeek = document.getElementById("btnThisWeek");
      const muscleBody = document.getElementById("muscleBody");

      let muscleChart = null;

      function equipmentAvailable(p) {
        const eq = p.training.equipment || {};
        const out = new Set();
        for (const e of EQUIPMENT) if (eq[e.id]) out.add(e.id);
        out.add("none");
        return out;
      }

      function hasEquip(ex, availableSet) {
        const need = ex.equip || [];
        return need.every((id) => availableSet.has(id));
      }

      function renderEquipmentChecks(p) {
        equipmentChecks.innerHTML = EQUIPMENT.filter((e) => e.id !== "none")
          .map((e) => {
            const checked = p.training.equipment?.[e.id] ? "checked" : "";
            return `
              <label class="flex items-center gap-2 rounded-xl border border-zinc-200 px-2 py-2 bg-white">
                <input type="checkbox" data-eq="${escapeAttr(e.id)}" ${checked} />
                <span>${escapeHtml(e.label)}</span>
              </label>
            `;
          })
          .join("");

        equipmentChecks.querySelectorAll("input[type='checkbox'][data-eq]").forEach((cb) => {
          cb.addEventListener("change", () => {
            const id = cb.dataset.eq;
            p.training.equipment[id] = cb.checked;
            saveState();
            render();
          });
        });
      }

      btnSaveTraining.addEventListener("click", () => {
        const p = currentProfile();
        p.training.location = trainingLocation.value;
        p.training.daysPerWeek = clamp(Number(trainingDays.value) || 3, 1, 7);
        saveState();
        render();
      });

      btnAddWorkout.addEventListener("click", () => {
        const p = currentProfile();
        const dateISO = prompt("–î–∞—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (YYYY-MM-DD)", isoToday());
        if (!dateISO) return;
        p.workouts.unshift({ dateISO, entries: [] });
        saveState();
        render();
        setTab("workouts");
      });

      workoutLogs.addEventListener("click", (ev) => {
        const btn = ev.target.closest("button");
        if (!btn) return;
        const action = btn.dataset.action;
        const idx = Number(btn.dataset.idx);
        const p = currentProfile();
        const log = p.workouts[idx];
        if (!log) return;

        if (action === "delWorkout") {
          if (!confirm("–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?")) return;
          p.workouts.splice(idx, 1);
          saveState();
          render();
          return;
        }

        if (action === "addEntry") {
          const root = btn.closest("[data-log]");
          const exId = root.querySelector("select[data-field='ex']")?.value;
          const sets = Number(root.querySelector("input[data-field='sets']")?.value) || 0;
          if (!exId || sets <= 0) return;
          log.entries.push({ exerciseId: exId, sets });
          saveState();
          render();
          return;
        }

        if (action === "delEntry") {
          const eidx = Number(btn.dataset.eidx);
          log.entries.splice(eidx, 1);
          saveState();
          render();
          return;
        }
      });

      btnThisWeek.addEventListener("click", () => {
        const p = currentProfile();
        p.nutrition.weekStartISO = weekStartMondayISO();
        saveState();
        render();
      });

      function computeWeeklyMuscles(p) {
        const start = p.nutrition.weekStartISO || weekStartMondayISO();
        const end = addDaysISO(start, 6);
        const weekLogs = (p.workouts || []).filter((w) => w.dateISO >= start && w.dateISO <= end);

        const map = new Map();
        const add = (muscle, kind, amount) => {
          if (!muscle || amount <= 0) return;
          const cur = map.get(muscle) || { primary: 0, secondary: 0 };
          cur[kind] += amount;
          map.set(muscle, cur);
        };

        for (const log of weekLogs) {
          for (const ent of log.entries || []) {
            const ex = EXERCISES.find((x) => x.id === ent.exerciseId);
            if (!ex) continue;
            const sets = Number(ent.sets) || 0;
            add(ex.muscle || "–î—Ä—É–≥–æ–µ", "primary", sets);
            for (const sm of ex.secondary || []) add(sm, "secondary", sets);
          }
        }

        const rows = Array.from(map.entries())
          .map(([muscle, v]) => ({ muscle, primary: v.primary, secondary: v.secondary, score: v.primary + v.secondary * 0.5 }))
          .sort((a, b) => b.score - a.score);

        const totalScore = rows.reduce((a, r) => a + r.score, 0);
        return {
          start,
          end,
          rows: rows.map((r) => ({ ...r, share: totalScore ? Math.round((r.score / totalScore) * 100) : 0 })),
        };
      }

      function renderMuscleReport() {
        const p = currentProfile();
        const rep = computeWeeklyMuscles(p);

        muscleBody.innerHTML = rep.rows
          .map((r) => {
            return `
              <tr class="border-t border-zinc-200">
                <td class="px-3 py-2 font-medium">${escapeHtml(r.muscle)}</td>
                <td class="px-3 py-2">${r.primary}</td>
                <td class="px-3 py-2">${r.secondary}</td>
                <td class="px-3 py-2">${r.share}%</td>
              </tr>
            `;
          })
          .join("");

        const labels = rep.rows.map((r) => r.muscle);
        const prim = rep.rows.map((r) => r.primary);
        const sec = rep.rows.map((r) => r.secondary);

        const canvas = document.getElementById("muscleChart");
        if (!canvas) return;

        if (muscleChart) {
          muscleChart.destroy();
          muscleChart = null;
        }

        muscleChart = new Chart(canvas, {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: "–ì–ª–∞–≤–Ω–∞—è (–ø–æ–¥—Ö–æ–¥—ã)", data: prim, stack: "a" },
              { label: "–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è (–ø–æ–¥—Ö–æ–¥—ã)", data: sec, stack: "a" },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "bottom" } },
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
          },
        });
      }

      function renderWorkoutLogs(p) {
        const available = equipmentAvailable(p);
        const exOptions = EXERCISES
          .slice()
          .sort((a, b) => a.name.localeCompare(b.name, "ru"))
          .map((ex) => `<option value="${escapeAttr(ex.id)}">${escapeHtml(ex.name)}</option>`)
          .join("");

        workoutLogs.innerHTML = (p.workouts || [])
          .map((w, idx) => {
            const entries = (w.entries || [])
              .map((e, eidx) => {
                const ex = EXERCISES.find((x) => x.id === e.exerciseId);
                const media = p.library.exerciseMedia?.[ex?.id] || placeholderSVG(ex?.name || "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ", ex?.muscle || "");
                const badge = ex && hasEquip(ex, available) ? "bg-emerald-50 border-emerald-200 text-emerald-700" : "bg-rose-50 border-rose-200 text-rose-700";
                return `
                  <div class="flex items-start justify-between gap-2 rounded-2xl border border-zinc-200 p-2">
                    <div class="flex items-start gap-3">
                      <div class="rounded-xl border border-zinc-200 overflow-hidden bg-zinc-50">${renderMedia(media, ex?.name || "", "thumb")}</div>
                      <div>
                        <div class="text-sm font-medium">${escapeHtml(ex?.name || "(–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)")}</div>
                        <div class="text-xs text-zinc-500">–ì–ª–∞–≤–Ω–∞—è: ${escapeHtml(ex?.muscle || "‚Äî")}${ex?.secondary?.length ? ` ¬∑ –í—Å–ø–æ–º: ${escapeHtml(ex.secondary.join(", "))}` : ""}</div>
                        <div class="text-xs text-zinc-500">–ü–æ–¥—Ö–æ–¥—ã: <b>${Number(e.sets) || 0}</b></div>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="rounded-xl border px-2 py-1 text-xs ${badge}">${ex && hasEquip(ex, available) ? "–¥–æ—Å—Ç—É–ø–Ω–æ" : "–Ω–µ—Ç"}</span>
                      <button data-action="delEntry" data-idx="${idx}" data-eidx="${eidx}" class="rounded-xl border border-zinc-200 bg-white px-2 py-1 text-xs">‚úï</button>
                    </div>
                  </div>
                `;
              })
              .join("");

            return `
              <div class="rounded-3xl border border-zinc-200 p-3" data-log>
                <div class="flex items-center justify-between gap-2">
                  <div>
                    <div class="text-sm text-zinc-500">${escapeHtml(w.dateISO)}</div>
                    <div class="text-lg font-semibold">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
                  </div>
                  <button data-action="delWorkout" data-idx="${idx}" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm">–£–¥–∞–ª–∏—Ç—å</button>
                </div>

                <div class="mt-3 grid gap-2">
                  ${entries || `<div class="text-sm text-zinc-500">–ü–æ–∫–∞ –Ω–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>`}
                </div>

                <div class="mt-3 flex flex-wrap gap-2 items-center">
                  <select data-field="ex" class="flex-1 min-w-[220px] rounded-xl border border-zinc-200 px-3 py-2 text-sm">${exOptions}</select>
                  <input data-field="sets" type="number" min="1" placeholder="–ø–æ–¥—Ö–æ–¥—ã" class="w-28 rounded-xl border border-zinc-200 px-3 py-2 text-sm" />
                  <button data-action="addEntry" data-idx="${idx}" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
              </div>
            `;
          })
          .join("");
      }

      // Progress (measures)
      const measureDate = document.getElementById("measureDate");
      const measureWeight = document.getElementById("measureWeight");
      const measureWaist = document.getElementById("measureWaist");
      const btnAddMeasure = document.getElementById("btnAddMeasure");
      const measuresBody = document.getElementById("measuresBody");
      let weightChart = null;

      btnAddMeasure.addEventListener("click", () => {
        const p = currentProfile();
        const dateISO = measureDate.value || isoToday();
        const weightKg = Number(measureWeight.value) || 0;
        if (!weightKg) return alert("–í–≤–µ–¥–∏ –≤–µ—Å.");
        const waist = Number(measureWaist.value);
        p.measures.push({ dateISO, weightKg, waistCm: waist || undefined });
        p.measures = p.measures.slice().sort((a, b) => (a.dateISO > b.dateISO ? 1 : -1));
        p.profile.weightKg = weightKg;
        saveState();
        measureWeight.value = "";
        measureWaist.value = "";
        render();
      });

      function renderMeasures(p) {
        const list = (p.measures || []).slice().sort((a, b) => (a.dateISO > b.dateISO ? 1 : -1));
        measuresBody.innerHTML = list
          .map((m, idx) => {
            return `
              <tr class="border-t border-zinc-200">
                <td class="px-3 py-2">${escapeHtml(m.dateISO)}</td>
                <td class="px-3 py-2 font-medium">${round(m.weightKg, 1)} –∫–≥</td>
                <td class="px-3 py-2">${m.waistCm ? round(m.waistCm, 1) + " —Å–º" : "‚Äî"}</td>
                <td class="px-3 py-2"><button data-del-measure="${idx}" class="rounded-xl border border-zinc-200 bg-white px-2 py-1 text-xs">‚úï</button></td>
              </tr>
            `;
          })
          .join("");

        measuresBody.querySelectorAll("button[data-del-measure]").forEach((b) => {
          b.addEventListener("click", () => {
            const i = Number(b.dataset.delMeasure);
            if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ä?")) return;
            p.measures.splice(i, 1);
            saveState();
            render();
          });
        });

        const labels = list.map((x) => x.dateISO);
        const dataW = list.map((x) => x.weightKg);
        const canvas = document.getElementById("weightChart");
        if (!canvas) return;

        if (weightChart) {
          weightChart.destroy();
          weightChart = null;
        }

        weightChart = new Chart(canvas, {
          type: "line",
          data: { labels, datasets: [{ label: "–í–µ—Å (–∫–≥)", data: dataW, tension: 0.25 }] },
          options: { responsive: true, plugins: { legend: { position: "bottom" } }, scales: { y: { beginAtZero: false } } },
        });
      }

      // Exercises
      const exerciseSearch = document.getElementById("exerciseSearch");
      const exerciseAvailability = document.getElementById("exerciseAvailability");
      const exerciseList = document.getElementById("exerciseList");

      function renderExercises(p) {
        const q = exerciseSearch.value.trim().toLowerCase();
        const only = exerciseAvailability.value === "only";
        const available = equipmentAvailable(p);

        const list = EXERCISES
          .filter((e) => !q || e.name.toLowerCase().includes(q))
          .filter((e) => !only || hasEquip(e, available))
          .slice()
          .sort((a, b) => a.name.localeCompare(b.name, "ru"));

        exerciseList.innerHTML = list
          .map((ex) => {
            const media = p.library.exerciseMedia?.[ex.id] || placeholderSVG(ex.name, `${ex.muscle}${ex.secondary?.length ? " + " + ex.secondary.slice(0, 2).join(", ") : ""}`);
            const can = hasEquip(ex, available);
            const canBadge = can ? "bg-emerald-50 border-emerald-200 text-emerald-700" : "bg-rose-50 border-rose-200 text-rose-700";
            const hasCustom = Boolean(p.library.exerciseMedia?.[ex.id]);
            return `
              <div class="rounded-3xl border border-zinc-200 p-3">
                <div class="flex items-start justify-between gap-2">
                  <div class="flex items-start gap-3">
                    <button data-action="toggleMedia" data-ex="${escapeAttr(ex.id)}" class="rounded-xl overflow-hidden border border-zinc-200 bg-zinc-50">${renderMedia(media, ex.name, "thumb")}</button>
                    <div>
                      <div class="text-sm font-semibold">${escapeHtml(ex.name)}</div>
                      <div class="text-xs text-zinc-500">–ì–ª–∞–≤–Ω–∞—è: ${escapeHtml(ex.muscle)}${ex.secondary?.length ? ` ¬∑ –í—Å–ø–æ–º: ${escapeHtml(ex.secondary.join(", "))}` : ""}</div>
                      <div class="mt-2 text-xs text-zinc-500">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: ${(ex.equip || []).map((id) => escapeHtml(EQUIPMENT.find((x) => x.id === id)?.label || id)).join(", ")}</div>
                      <div class="mt-1 text-xs text-zinc-500">–ó–∞–º–µ–Ω–∞: ${escapeHtml(ex.alt || "‚Äî")}</div>
                      <div class="mt-2 flex flex-wrap gap-2">
                        <button data-action="setMedia" data-ex="${escapeAttr(ex.id)}" class="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm">–î–æ–±–∞–≤–∏—Ç—å GIF/–≤–∏–¥–µ–æ</button>
                        <button data-action="resetMedia" data-ex="${escapeAttr(ex.id)}" class="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm" ${hasCustom ? "" : "disabled"}>–°–±—Ä–æ—Å</button>
                        <span class="rounded-xl border px-2 py-1 text-xs ${canBadge}">${can ? "–¥–æ—Å—Ç—É–ø–Ω–æ" : "–Ω–µ—Ç"}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mt-3 hidden" id="media-${escapeAttr(ex.id)}">
                  <div class="rounded-2xl border border-zinc-200 bg-zinc-50 p-2">${renderMedia(media, ex.name, "full")}</div>
                  <div class="mt-2 text-xs text-zinc-500">GIF —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞. –í–∏–¥–µ–æ (mp4/webm) ‚Äî –ø–æ–∫–∞–∂–µ—Ç –ø–ª–µ–µ—Ä.</div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      exerciseList.addEventListener("click", (ev) => {
        const btn = ev.target.closest("button");
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.ex;
        const p = currentProfile();
        if (!id) return;

        if (action === "toggleMedia") {
          const box = document.getElementById("media-" + id);
          if (box) box.classList.toggle("hidden");
          return;
        }

        if (action === "setMedia") {
          const cur = p.library.exerciseMedia?.[id] || "";
          const url = prompt(
            "–í—Å—Ç–∞–≤—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–π GIF (.gif) –∏–ª–∏ –≤–∏–¥–µ–æ (.mp4/.webm).

–û—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º –∏ –Ω–∞–∂–º–∏ OK ‚Äî —á—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å.",
            cur
          );
          if (url === null) return;
          const trimmed = url.trim();
          if (!trimmed) return;
          p.library.exerciseMedia[id] = trimmed;
          saveState();
          render();
          return;
        }

        if (action === "resetMedia") {
          delete p.library.exerciseMedia[id];
          saveState();
          render();
          return;
        }
      });

      exerciseSearch.addEventListener("input", () => render());
      exerciseAvailability.addEventListener("change", () => render());

      // Render coordinator
      function renderMenu() {
        const p = currentProfile();
        const start = p.nutrition.weekStartISO || weekStartMondayISO();
        menuWeekTitle.textContent = start;
        weekStartInput.value = start;

        const dateISO = getSelectedDateISO(p);
        ensureDay(p, dateISO);

        dayTitle.textContent = `${dateISO} (–¥–µ–Ω—å ${selectedDayOffset + 1}/7)`;

        mealsGrid.innerHTML = MEAL_KEYS.map((m) => renderMealEditor(p, dateISO, m.key)).join("");

        const totals = recomputeDayTotals(p, dateISO);
        dayTotals.textContent = `${totals.kcal} –∫–∫–∞–ª`;
        dayTotalsSub.textContent = `–ë/–ñ/–£: ${totals.p}/${totals.f}/${totals.c}`;

        renderFoods();
      }

      function renderShopping() {
        const p = currentProfile();
        const { start, rows, total } = computeShopping(p);
        shoppingWeekTitle.textContent = start;
        shoppingSummary.textContent = `${total.kcal} –∫–∫–∞–ª ¬∑ –ë/–ñ/–£ ${round(total.p, 1)}/${round(total.f, 1)}/${round(total.c, 1)}`;
        shoppingBody.innerHTML = rows
          .map((r) => {
            return `
              <tr class="border-t border-zinc-200">
                <td class="px-3 py-2 font-medium">${escapeHtml(r.name)}</td>
                <td class="px-3 py-2">${r.grams} –≥</td>
                <td class="px-3 py-2">${r.kcal}</td>
                <td class="px-3 py-2">${r.p}/${r.f}/${r.c}</td>
              </tr>
            `;
          })
          .join("");
      }

      function renderWorkouts() {
        const p = currentProfile();
        trainingLocation.value = p.training.location;
        trainingDays.value = String(p.training.daysPerWeek || 3);
        renderEquipmentChecks(p);
        renderWorkoutLogs(p);
        renderMuscleReport();
      }

      function renderProgress() {
        const p = currentProfile();
        measureDate.value = isoToday();
        renderMeasures(p);
      }

      function renderExercisesTab() {
        const p = currentProfile();
        renderExercises(p);
      }

      function render() {
        rebuildProfileSelect();
        renderForecast();

        if (activeTab === "menu") renderMenu();
        if (activeTab === "shopping") renderShopping();
        if (activeTab === "workouts") renderWorkouts();
        if (activeTab === "progress") renderProgress();
        if (activeTab === "exercises") renderExercisesTab();
      }

      // Initial
      rebuildProfileSelect();
      setTab("dashboard");
      render();
    </script>
  </body>
</html>
